<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product View Page</title>
  <!-- Link to external CSS -->
  <link rel="stylesheet" href="productDetails.css">
</head>
<body>
  <div class="container">
    <div class="product-section">
      <div class="product-content">
        <!-- Gallery -->
        <div class="product-gallery">
          <div class="main-image" id="mainImgContainer">
            <img id="mainImg" src="" alt="Product Image">
          </div>
          <div class="thumbnail-container" id="thumbnails"></div>
        </div>

        <!-- Product Info -->
        <div class="product-info">
          <div class="product-title-container">
            <h1 class="product-title" id="productName">Product Name</h1>
            <div class="tags-container" style="margin-top:5px;">
              <span class="best-seller-tag" id="bestSellerTag">Best Seller</span>
              <span class="category-tag" id="categoryTag">Category</span>
            </div>
          </div>
          <div class="product-price" id="productPrice">$0.00</div>
          <div class="star-rating"><span class="stars">★★★★★</span> <span class="rating-text">(0/5.0)</span></div>
          <p class="product-description" id="productDetails">Loading details...</p>
          <div class="quantity-selector">
            <span class="quantity-label">Quantity:</span>
            <div class="quantity-controls">
              <button class="quantity-btn" id="decrease-btn">−</button>
              <div class="quantity-value" id="quantity-value">1</div>
              <button class="quantity-btn" id="increase-btn">+</button>
            </div>
          </div>
          <button class="contact-btn" id="contactBtn">Contact Us</button>
        </div>
      </div>

      <!-- Related products container -->
      <div class="related-products" id="relatedProducts">
        <h2 class="section-title">Related Products</h2>
        <div class="related-list" id="relatedList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "../firebase-config.js";
    import { doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    const nameEl = document.getElementById('productName');
    const mainImg = document.getElementById('mainImg');
    const thumbnails = document.getElementById('thumbnails');
    const detailsEl = document.getElementById('productDetails');
    const bestSellerTag = document.getElementById('bestSellerTag');
    const categoryTag = document.getElementById('categoryTag');
    const relatedList = document.getElementById('relatedList');

    let quantity = 1;
    let currentCategory = '';

    async function loadProduct() {
        if (!id) {
            nameEl.textContent = "No product selected";
            bestSellerTag.style.display = 'none';
            categoryTag.style.display = 'none';
            return;
        }

        const ref = doc(db, 'Products', id);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
            nameEl.textContent = "Product not found";
            bestSellerTag.style.display = 'none';
            categoryTag.style.display = 'none';
            return;
        }

        const data = snap.data();

        // Name, price, and category
        nameEl.textContent = data.name || "(no name)";
        document.getElementById('productPrice').textContent = data.price || "$0.00";
        bestSellerTag.style.display = data.bestSeller ? 'inline-block' : 'none';
        if (data.category) {
            categoryTag.textContent = data.category;
            categoryTag.style.display = 'inline-block';
            currentCategory = data.category;
        } else {
            categoryTag.style.display = 'none';
        }

        // Images
        const images = [data.mainUrl, ...(Array.isArray(data.images) ? data.images : [])].filter(Boolean);
        mainImg.src = images[0] || '';
        thumbnails.innerHTML = '';
        images.forEach((url, i) => {
            const thumb = document.createElement('img');
            thumb.src = url;
            if (i === 0) thumb.classList.add('active');

            thumb.addEventListener('click', () => {
                if (mainImg.src === url) return;
                mainImg.classList.add('fade-out');
                setTimeout(() => {
                    mainImg.src = url;
                    mainImg.classList.remove('fade-out');
                }, 400);
                Array.from(thumbnails.children).forEach(img => img.classList.remove('active'));
                thumb.classList.add('active');
            });

            thumbnails.appendChild(thumb);
        });

        // Product details with Show more/Show less
        const fullText = data.details || "(No details available)";
        const lines = fullText.split('\n');
        const maxLines = 3;
        let expanded = false;

        function renderDetails() {
            detailsEl.innerHTML = '';
            const textSpan = document.createElement('span');
            textSpan.textContent = (!expanded && lines.length > maxLines) 
                ? lines.slice(0, maxLines).join('\n') + '...' 
                : fullText;
            detailsEl.appendChild(textSpan);

            if (lines.length > maxLines) {
                const link = document.createElement('span');
                link.textContent = expanded ? ' Show less' : ' Show more';
                link.className = 'show-more-link';
                link.style.cursor = 'pointer';
                link.addEventListener('click', () => {
                    expanded = !expanded;
                    renderDetails();
                });
                detailsEl.appendChild(link);
            }
        }

        renderDetails();
        loadRelatedProducts();
    }

    async function loadRelatedProducts() {
        if (!currentCategory) return;
        const productsRef = collection(db, 'Products');
        const q = query(productsRef, where('category', '==', currentCategory));
        const snapshot = await getDocs(q);

        const allRelated = [];
        snapshot.forEach(docSnap => {
            if (docSnap.id !== id) allRelated.push({ id: docSnap.id, ...docSnap.data() });
        });

        // Pick up to 4 available products
        const available = allRelated.filter(p => p.available !== false);
        const shuffled = available.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 4);

        relatedList.innerHTML = '';
        selected.forEach(prod => {
            const div = document.createElement('div');
            div.className = 'product-card';
            div.innerHTML = `
                <img src="${prod.mainUrl || ''}" alt="${prod.name}">
                <div class="card-content">
                  <div class="title">${prod.name}</div>
            <div class="card-buttons">
  <button class="view-btn">View</button>
  <button class="contact-btn">Contact</button>
</div>

                </div>
            `;
            div.addEventListener('click', () => {
                window.location.href = `./productDetails.html?id=${prod.id}`;
            });
            relatedList.appendChild(div);
        });
    }

    loadProduct();

    // Quantity buttons
    document.getElementById('decrease-btn').addEventListener('click', () => {
        if (quantity > 1) {
            quantity--;
            document.getElementById('quantity-value').textContent = quantity;
        }
    });
    document.getElementById('increase-btn').addEventListener('click', () => {
        quantity++;
        document.getElementById('quantity-value').textContent = quantity;
    });

    // Contact button
    document.getElementById('contactBtn').addEventListener('click', () => {
        const message = document.createElement('div');
        message.textContent = 'Thank you for your interest! We will contact you soon.';
        message.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 15px 30px; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 1000;';
        document.body.appendChild(message);
        setTimeout(() => message.remove(), 3000);
    });

    // Fullscreen image click
    mainImg.addEventListener('click', () => {
        if (mainImg.requestFullscreen) mainImg.requestFullscreen();
        else if (mainImg.webkitRequestFullscreen) mainImg.webkitRequestFullscreen();
        else if (mainImg.msRequestFullscreen) mainImg.msRequestFullscreen();
    });
  </script>
</body>
</html>
