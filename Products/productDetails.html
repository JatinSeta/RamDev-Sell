<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product View Page</title>
  <link rel="stylesheet" href="./productDetails.css">
</head>
<body>

<!-- Breadcrumb -->
<nav class="breadcrumb-nav">
  <a href="../index.html">Home</a> › 
  <a href="../Products/Products.html">Products</a> › 
  <span id="breadcrumbName">Product Name</span>
</nav>

<div class="container">
  <div class="product-section">
    <div class="product-content">

      <!-- GALLERY -->
      <div class="product-gallery">
        <div class="main-image">
          <img id="mainImg" src="" alt="Product Image">
        </div>
        <div class="thumbnail-container" id="thumbnails"></div>
      </div>

      <!-- PRODUCT INFO -->
      <div class="product-info">
        <div class="product-title-container">
          <h1 class="product-title" id="productName">Product Name</h1>
          <div class="tags-container">
            <span class="best-seller-tag" id="bestSellerTag">Best Seller</span>
            <span class="category-tag" id="categoryTag">Category</span>
            <span class="product-brand" id="productBrand">Brand: Not specified</span>
          </div>
        </div>

        <div class="product-price" id="productPrice">₹0.00</div>

        <div class="star-rating">
          <span class="stars">★★★★★</span>
          <span class="rating-text">(0/5.0)</span>
        </div>

        <!-- PRODUCT DESCRIPTION WITH READ MORE -->
        <p id="productDetails">Loading details...</p>
        <span id="readMore" style="cursor:pointer;color:blue;">... Read more</span>

        <!-- QUANTITY -->
        <div class="quantity-selector">
          <span class="quantity-label">Quantity:</span>
          <div class="quantity-controls">
            <button class="quantity-btn" id="decrease-btn">−</button>
            <div class="quantity-value" id="quantity-value">1</div>
            <button class="quantity-btn" id="increase-btn">+</button>
          </div>
        </div>

        <button class="contact-btn" id="contactBtn">Contact Us</button>
      </div>
    </div>

    <!-- RELATED PRODUCTS -->
    <div class="related-products">
      <h2 class="section-title">Related Products</h2>
      <div class="related-list" id="relatedList"></div>
    </div>

    <!-- EXTRA DETAILS -->
    <div class="extra-fields">
      <h2 class="section-title">About Product Details</h2>
      <table class="extra-fields-table">
        <tbody id="extraFieldsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script type="module">
  import { db } from "../firebase-config.js";
  import { doc, getDoc, collection, getDocs, query, where } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  const breadcrumbName = document.getElementById("breadcrumbName");
  const productName = document.getElementById("productName");
  const productPrice = document.getElementById("productPrice");
  const productBrand = document.getElementById("productBrand");
  const bestSellerTag = document.getElementById("bestSellerTag");
  const categoryTag = document.getElementById("categoryTag");
  const productDetails = document.getElementById("productDetails");
  const readMore = document.getElementById("readMore");
  const mainImg = document.getElementById("mainImg");
  const thumbnails = document.getElementById("thumbnails");
  const relatedList = document.getElementById("relatedList");
  const extraFieldsBody = document.getElementById("extraFieldsBody");

  let quantity = 1;
  let currentCategory = "";
  let isExpanded = false;

  async function loadProduct() {
    if (!id) return;

    const ref = doc(db, "Products", id);
    const snap = await getDoc(ref);

    if (!snap.exists()) return;

    const data = snap.data();

    // Product basic info
    productName.textContent = data.name || "Unnamed Product";
    breadcrumbName.textContent = data.name || "Product";
    productPrice.textContent = `₹${data.price || "0.00"}`;
    productBrand.textContent = `Brand: ${data.brand || "Not specified"}`;
    bestSellerTag.style.display = data.bestSeller ? "inline-block" : "none";

    if (data.category) {
      categoryTag.textContent = data.category;
      categoryTag.style.display = "inline-block";
      currentCategory = data.category;
    } else {
      categoryTag.style.display = "none";
    }

    // Images
    const images = [data.mainUrl, ...(data.images || [])].filter(Boolean);
    mainImg.src = images[0] || "";

    thumbnails.innerHTML = "";
    images.forEach((img, i) => {
      const thumb = document.createElement("img");
      thumb.src = img;
      if (i === 0) thumb.classList.add("active");

      thumb.onclick = () => {
        mainImg.src = img;
        document.querySelectorAll(".thumbnail-container img").forEach(t => t.classList.remove("active"));
        thumb.classList.add("active");
      };

      thumbnails.appendChild(thumb);
    });

    // Description with Read More
    const desc = data.details || "No description available.";
    const previewLines = 5;
    const descLines = desc.split("\n");

    if (descLines.length > previewLines) {
      const shortDesc = descLines.slice(0, previewLines).join("\n");
      productDetails.textContent = shortDesc;
      readMore.style.display = "inline";
      readMore.onclick = () => {
        if (!isExpanded) {
          productDetails.textContent = desc;
          readMore.textContent = " Show less";
          isExpanded = true;
        } else {
          productDetails.textContent = shortDesc;
          readMore.textContent = "... Read more";
          isExpanded = false;
        }
      };
    } else {
      productDetails.textContent = desc;
      readMore.style.display = "none";
    }

    // Extra fields table
    extraFieldsBody.innerHTML = "";
    (data.extraFields || []).forEach(f => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${f.key}</td><td>${f.value}</td>`;
      extraFieldsBody.appendChild(tr);
    });

    loadRelatedProducts();
  }

  async function loadRelatedProducts() {
    if (!currentCategory) return;

    const q = query(collection(db, "Products"), where("category", "==", currentCategory));
    const snap = await getDocs(q);
    relatedList.innerHTML = "";

    snap.forEach(docSnap => {
      if (docSnap.id === id) return;

      const p = docSnap.data();
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        <img src="${p.mainUrl || ""}">
        <div class="card-content">
          <div class="title">${p.name}</div>
          <div class="card-buttons">
            <button class="contact-btn">Contact</button>
          </div>
        </div>
      `;
      card.onclick = () => {
        window.location.href = `./productDetails.html?id=${docSnap.id}`;
      };
      relatedList.appendChild(card);
    });
  }

  // Quantity controls
  document.getElementById("increase-btn").onclick = () => {
    document.getElementById("quantity-value").textContent = ++quantity;
  };
  document.getElementById("decrease-btn").onclick = () => {
    if (quantity > 1) document.getElementById("quantity-value").textContent = --quantity;
  };

  // Contact button
  document.getElementById("contactBtn").onclick = () => {
    alert("Thank you! We will contact you soon.");
  };

  loadProduct();
</script>

</body>
</html>
